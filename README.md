# three.jsで数学勉強するプロジェクト

数学勉強といいつつ、Unityライクな開発ができるような
オレオレフレームワークの開発になっているので自分用にメモを残す。

基本的に`app.ts`のAppクラスが全て

## 現状

- ユニットとシステムの大きく２つに大別される
- ユニットは各種3Dオブジェクト
- システムはゲーム作る時にだいたいいるよねっていうシングルトンたち

- メッシュやマテリアル、テクスチャなどのリソースも作りたいかも
- あとツール郡

## システム

- sRender:描画を司る
- sCamera:カメラ持ってる
- sScene:シーンの切り替えを担当する
- sClock:時間管理
- sUnit:ユニットを毎フレーム更新したりする

## プログラムの流れ

### 1.アプリケーションの初期化
`app.ts`でアプリケーションの生成と実行をしている。

### 2.App.init
Appクラスのinitでは各種システムのinitを実行する
最後に最初に呼び出すシーンをロードする。
(URLにGetパラメータつけて最初にロードするシーンを変えるとかはここで制御するとよい)

- sRenderの初期化でcanvasや描画サイズなどからrendererが生成される
- sSceneではシーンの定義ファイルをもとにシーンを扱う準備が整う
- sCameraはとりあえずカメラを用意する。(すごく暫定対応のまま)
- sClockではタイマーを使う準備

### 3.App.execute
各種システムのupdateを呼び出す。
`requestAnimationFrame(this.execute);`することで毎フレームこの処理が動く。

- sClock.update(): 経過時間が更新される
- sScene.update(): シーンのロードや切り替えがあるかを監視、あれば切り替えをする
- sUnit.update() : 登録されてるユニットのupdate()を呼び出す。

## 開発のお約束

### まずシーンを作成する。
- uSceneを継承して任意のSceneクラスを作る
- `src/scripts/settings/scene.ts`にシーン名とクラスを追記する。  
これをする事で`sScene.loadBy(sceneName)`でシーンが生成できるようになる。
- Sceneをロードすると自動的にScene.initが実行されるのでここでユニットを生成するなりする。

### ユニットの決まり事
- ユニットはプレイヤーとかBoxとかそれぞれ何かしらのオブジェクト
- uUnitを継承して任意のUnitクラスを作ろう
- ユニットの生成後
  - ユニットはシーンに登録する事で描画されるようになる
  - ユニットはsUnitに登録する事で毎フレームupdateが呼ばれるようになる
- `unit.enter(LINE_NO, scene)`とすることでsUnitとシーンに登録される
- `unit.exit()`とすることでsUnitとシーンから外される。
- 必要に応じて`dispose()`を定義すること
これはユニットが破棄される時に実行されるメソッドになっている。
メンバ変数に何かしら参照を持っている場合はnullをいれて参照を解除するといった処理を行う。
これをする事でメモリリークしないようにすることができる。

### シーン切り替え時の挙動
- シーンを切り替える時、そのシーンに所属しているユニットは自動的に  
登録されているsUnitとシーンから除外され、さらに`unit.dispose()`がコールされる。
- これは`unit.enter`したときにユニットに所属するシーンやsUnitの情報を持たせて実現してる。
- インスタンスの参照が解除される事でガベコレ対象になる。